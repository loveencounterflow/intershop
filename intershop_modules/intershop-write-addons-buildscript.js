// Generated by CoffeeScript 2.4.1
(function() {
  'use strict';
  var CND, FS, PATH, alert, badge, cast, check, debug, declare, declare_check, echo, help, info, is_sad, isa, jr, rpr, squel, type_of, types, urge, validate, warn, whisper;

  //###########################################################################################################
  CND = require('cnd');

  rpr = CND.rpr;

  badge = 'INTERSHOP/INTERSHOP-WRITE-ADDONS-BUILDSCRIPT';

  debug = CND.get_logger('debug', badge);

  alert = CND.get_logger('alert', badge);

  whisper = CND.get_logger('whisper', badge);

  warn = CND.get_logger('warn', badge);

  help = CND.get_logger('help', badge);

  urge = CND.get_logger('urge', badge);

  info = CND.get_logger('info', badge);

  echo = CND.echo.bind(CND);

  //...........................................................................................................
  PATH = require('path');

  FS = require('fs');

  // resolve_pkg               = require 'resolve-pkg'
  // package_json              = require PATH.resolve PATH.join process.env.intershop_host_path, 'package.json'
  //...........................................................................................................
  types = new (require('intertype')).Intertype();

  ({isa, validate, cast, check, declare, declare_check, is_sad, type_of} = types.export());

  //...........................................................................................................
  ({jr} = CND);

  squel = (require('squel')).useFlavour('postgres');

  // require 'cnd/lib/exception-handler'

  //-----------------------------------------------------------------------------------------------------------
  this.as_line = function(sql) {
    return sql.toString() + ';';
  };

  //-----------------------------------------------------------------------------------------------------------
  this.add_addon = function(aoid, path, relpath) {
    var sql;
    sql = squel.insert().into('ADDONS.addons').set('aoid', aoid).set('path', path).set('relpath', relpath);
    return this.as_line(sql);
  };

  //-----------------------------------------------------------------------------------------------------------
  this.add_file = function(aoid, target, path, relpath) {
    var sql;
    sql = squel.insert().into('ADDONS.files').set('aoid', aoid).set('target', target).set('path', path).set('relpath', relpath);
    return this.as_line(sql);
  };

  //-----------------------------------------------------------------------------------------------------------
  this.write_buildscript = function(addons) {
    var abspath, addon, file, file_id, i, len, ref, ref1, relpath, target;
    validate.object(addons);
    ref = addons.addons;
    for (i = 0, len = ref.length; i < len; i++) {
      addon = ref[i];
      debug('^363673^', addon);
      info('^363674^', addon.module.path);
      echo();
      echo(`# ${'-'.repeat(108)}`);
      echo(`# Addon: ${addon.aoid}`);
      echo(`# ${addon.module.path}`);
      ref1 = addon.targets;
      // echo """postgres_unpaged -c "select generate_series( 1, 9 );" """
      for (file_id in ref1) {
        file = ref1[file_id];
        ({target, relpath, abspath} = file);
        switch (target) {
          case 'rebuild':
            /* TAINT must escape critical characters */
            echo(`echo -e $orange$reverse $reset$orange '${abspath}'$reset`);
            echo(`postgres_unpaged -f ${abspath}`);
        }
      }
    }
    // else
    //   echo "# skipping #{target} file #{abspath}"
    echo(`# ${'-'.repeat(108)}`);
    echo("# (end of addons)");
    echo();
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.write_sql_inserts = function(addons) {
    var abspath, addon, file, file_id, i, len, ref, relpath, target, write;
    validate.object(addons);
    FS.writeFileSync(addons.populate_sql_path, '');
    //.........................................................................................................
    write = function(x = '') {
      validate.text(x);
      FS.appendFileSync(addons.populate_sql_path, x + '\n');
      return null;
    };
    //.........................................................................................................
    write(`-- generated by ${__filename}`);
    write(`-- generated on ${(new Date()).toString()}`);
    write();
    for (i = 0, len = addons.length; i < len; i++) {
      addon = addons[i];
      write(this.add_addon(aoid, addon.module.path, addon.module.relpath));
      ref = addon.targets;
      for (file_id in ref) {
        file = ref[file_id];
        ({target, relpath, abspath} = file);
        write(this.add_file(aoid, target, abspath, relpath));
      }
    }
    return null;
  };

  //-----------------------------------------------------------------------------------------------------------
  this.generate_scripts = function() {
    var addons;
    addons = (require('./intershop-find-addons')).find_addons();
    this.write_buildscript(addons);
    this.write_sql_inserts(addons);
    return null;
  };

  //###########################################################################################################
  if (module === require.main) {
    (() => {
      return this.generate_scripts();
    })();
  }

}).call(this);

//# sourceMappingURL=intershop-write-addons-buildscript.js.map
