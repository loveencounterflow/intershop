#!/bin/bash
set -euo pipefail

#-----------------------------------------------------------------------------------------------------------
function extension_from_path () {
  local base
  base="$(basename "$1")"
  echo ${base##*.}; }

#-----------------------------------------------------------------------------------------------------------
function get_type_of_buildfile () {
  if [[ -x "$1" ]]; then
    echo 'executable'
  else
    extension_from_path "$1";
  fi; }

#-----------------------------------------------------------------------------------------------------------
function append_buildfiles_from_path () {
  for sql_buildfile_path in $( ls "$1"/@([0-9][0-9][0-9])-* | sort ); do
    sql_buildfile_type=$(get_type_of_buildfile "$sql_buildfile_path")
    #.......................................................................................................
    case $sql_buildfile_type in
      #.....................................................................................................
      'sql' )
        echo "echo XXX $sql_buildfile_path"               >> "$intershop_sql_buildscript_path"
        echo "postgres_unpaged -f $sql_buildfile_path"    >> "$intershop_sql_buildscript_path"
        ;;
      #.....................................................................................................
      'executable' )
        echo "echo XXX $sql_buildfile_path"               >> "$intershop_sql_buildscript_path"
        echo "$sql_buildfile_path"                        >> "$intershop_sql_buildscript_path"
        ;;
      #.....................................................................................................
      * )
        echo "$sql_buildfile_path is of unknown type"
        exit 1
        ;;
      esac
    done; }

# sql_buildfile_path=/path/some/file.foo.sql
# sql_buildfile_base="$(basename "$sql_buildfile_path")"
# sql_buildfile_extension=${sql_buildfile_base##*.}

# echo "sql_buildfile_path:       $sql_buildfile_path"
# echo "sql_buildfile_base:       $sql_buildfile_base"
# echo "sql_buildfile_extension:  $sql_buildfile_extension"
# echo "extension_from_path:      $(extension_from_path $sql_buildfile_path)"
# exit 1

#===========================================================================================================
# GENERATE GUEST SQL BUILDSCRIPT
#-----------------------------------------------------------------------------------------------------------
touch "$intershop_sql_buildscript_path"
chmod 0744 "$intershop_sql_buildscript_path"
ls -AlF "$intershop_sql_buildscript_path"

cat "$intershop_sql_buildscript_header_path" > "$intershop_sql_buildscript_path"
shopt -s extglob
if [[ $intershop_role == 'guest' ]]; then
  echo "adding guest SQL files from $intershop_guest_sql_path"
  append_buildfiles_from_path "$intershop_guest_sql_path"
  fi

#===========================================================================================================
# ADD HOST SQL BUILDSCRIPT LINES
#-----------------------------------------------------------------------------------------------------------
echo "adding host SQL files from $intershop_host_sql_path"
append_buildfiles_from_path "$intershop_host_sql_path"
