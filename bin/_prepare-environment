#!/usr/bin/env bash
# set -ex
set -e
set -u
set -o pipefail

#-----------------------------------------------------------------------------------------------------------
function show () {
  printf "$green%-50s $white%s$reset\n" "$1": "${!1}"; }

#-----------------------------------------------------------------------------------------------------------
function list () {
  ( for name in $(printenv | grep -o -E "^[a-z][^=]*" | sort ); do show "$name"; done ) || true; }

#-----------------------------------------------------------------------------------------------------------
function on_error () {
  echo -e "$red"'An error occurred; environment at this point:'"$reset"
  list; }
trap 'on_error' ERR


#-----------------------------------------------------------------------------------------------------------
# thx to https://stackoverflow.com/a/20579006/7568091
script_path="$(realpath "${BASH_SOURCE[0]}")"
intershop_paths_bin="$(dirname "$script_path")"                       ; export intershop_paths_bin
intershop_paths_npm_module="$(realpath "$intershop_paths_bin"/..)"    ; export intershop_paths_npm_module

#-----------------------------------------------------------------------------------------------------------
if [ -z ${intershop_paths_app+x} ]; then
  echo "$script_path"': need variable $intershop_paths_app'
  echo "terminating"
  exit 1
  fi
export intershop_paths_app

#-----------------------------------------------------------------------------------------------------------
intershop_paths_configuration="$intershop_paths_app"/intershop.ptv
if ! [[ -f $intershop_paths_configuration ]]; then
  echo "unable to find configuration file in $intershop_paths_configuration; terminating"
  exit 1
  fi

#-----------------------------------------------------------------------------------------------------------
cd "$intershop_paths_npm_module"
source bin/_trm

#-----------------------------------------------------------------------------------------------------------
intershop_system_user="$USER"                                             ; export intershop_system_user
intershop_app_name=intershop                                              ; export intershop_app_name
intershop_db_name=intershop                                               ; export intershop_db_name
intershop_db_user=intershop                                               ; export intershop_db_user
intershop_db_port='5432'                                                  ; export intershop_db_port
intershop_paths_own_js_modules="$home"/lib                                ; export intershop_paths_own_js_modules
intershop_paths_own_python_modules="$home"/python_modules                 ; export intershop_paths_own_python_modules
intershop_paths_app_python_modules="$intershop_paths_app"/python_modules  ; export intershop_paths_app_python_modules
intershop_paths_tmp='/tmp/'$intershop_db_name                             ; export intershop_paths_tmp
intershop_paths_psql_output=$intershop_paths_tmp'/psql-output'            ; export intershop_paths_psql_output
intershop_rpc_port='33333'                                                ; export intershop_rpc_port
intershop_rpc_host='localhost'                                            ; export intershop_rpc_host

#-----------------------------------------------------------------------------------------------------------
_blank_pattern="^[ \t]*$"
_comment_pattern="^[ \t]*#"
_3_fields_pattern="^([^ ]+) +([^ ]+) +(.+)$"

#-----------------------------------------------------------------------------------------------------------
function _match_ptv_line () {
  _ptv_key='';   export _ptv_key
  _ptv_type='';  export _ptv_type
  _ptv_value=''; export _ptv_value
  if [[ $1 =~ $_3_fields_pattern ]]; then
    _ptv_key="${BASH_REMATCH[1]}"
    _ptv_type="${BASH_REMATCH[2]}"
    _ptv_value="${BASH_REMATCH[3]}"
    fi; }

#-----------------------------------------------------------------------------------------------------------
function update_settings_from_app_ptv () {
  # thx to https://stackoverflow.com/a/10929511/7568091
  while IFS='' read -r line || [[ -n "$line" ]]; do
    if [[ $line =~ $_blank_pattern    ]]; then continue; fi
    if [[ $line =~ $_comment_pattern  ]]; then continue; fi
    _match_ptv_line "$line"
    _ptv_key=intershop_${_ptv_key//\//_}
    export "$_ptv_key"
    # thx to https://stackoverflow.com/a/48590164/7568091
    eval "$_ptv_key=\$_ptv_value"
    done < "$1"; }

update_settings_from_app_ptv "$intershop_paths_configuration"
# xxx
# echo 22821; exit 1

#-----------------------------------------------------------------------------------------------------------
# # I'd simply use a pipe here but that invalidates the `$!` (last PID) invocation:
# tail -f /tmp/psql-output | sed 's/^.*$/\x1b[38;05;214m\0\x1b[0m/g' &
# # Thx to https://stackoverflow.com/a/8048493/7568091
# # for the idea to redirect to a subshell to preserve the PID of the first command:
# ( tail -f "$intershop_paths_psql_output" 2> /dev/null ) > >( sed 's/^.*$/\x1b[38;05;214m\0\x1b[0m/g' ) &
# make sure output file exists with the correct rights:
mkdir -p $intershop_paths_tmp
chmod 0777 $intershop_paths_tmp
touch $intershop_paths_psql_output
chmod 0666 $intershop_paths_psql_output
truncate -s 0 $intershop_paths_psql_output
( tail -f $intershop_paths_psql_output 2> /dev/null ) > >( sed 's/^.*$/\x1b[38;05;214m\0\x1b[0m/g' ) &
psql_tailer_pid=$!

# # according to https://stackoverflow.com/a/8366378/7568091 we can also use trap "kill 0" SIGINT
trap 'kill $psql_tailer_pid' EXIT
# echo 'helo world' >> $intershop_paths_psql_output; ls -AlF /tmp/intershop*; exit 1


#-----------------------------------------------------------------------------------------------------------
function postgres_paged () {
  PAGER="postgres-pager -s 6 --less-status-bar" psql                                \
    -U $intershop_db_user -d $intershop_db_name -p $intershop_db_port               \
    --set=intershop_db_user="$intershop_db_user"                                    \
    --set=intershop_db_name="$intershop_db_name"                                    \
    --set=out="$intershop_paths_psql_output"                                        \
    --set QUIET=on --set ON_ERROR_STOP=1 "$@"; }

#-----------------------------------------------------------------------------------------------------------
function postgres_unpaged () {
  psql                                                                              \
    -U $intershop_db_user -d $intershop_db_name -p $intershop_db_port               \
    --set=intershop_db_user="$intershop_db_user"                                    \
    --set=intershop_db_name="$intershop_db_name"                                    \
    --set=out="$intershop_paths_psql_output"                                        \
    --set QUIET=on --set ON_ERROR_STOP=1 "$@"; }

#-----------------------------------------------------------------------------------------------------------
function sudo_postgres_unpaged () {
  sudo -u postgres psql                                                             \
    -p $intershop_db_port                                                           \
    --set=intershop_db_user="$intershop_db_user"                                    \
    --set=intershop_db_name="$intershop_db_name"                                    \
    --set=out="$intershop_paths_psql_output"                                        \
    --set QUIET=on --set ON_ERROR_STOP=1 "$@";
  if [[ $? != 0 ]]; then exit 123; fi
  }





