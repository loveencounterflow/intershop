#!/usr/bin/env bash
set -euo pipefail;IFS=$'\n\t'
# home="$(realpath "$(realpath "${BASH_SOURCE[0]}" | xargs dirname)"/..)"
# cd "$home"
grey='\x1b[38;05;240m'
blue='\x1b[38;05;27m'
lime='\x1b[38;05;118m'
orange='\x1b[38;05;208m'
reset='\x1b[0m'
function info () { set +u;  printf "$grey""INTERSHOP ""$blue%s$reset\n" "$1 $2 $3 $4 $5 $6";  set -u;  }
function help () { set +u;  printf "$grey""INTERSHOP ""$lime%s$reset\n" "$1 $2 $3 $4 $5 $6";  set -u;  }
function urge () { set +u;  printf "$grey""INTERSHOP ""$orange%s$reset\n" "$1 $2 $3 $4 $5 $6";  set -u;  }

info 'intershop command '"$0" "$@"

# declare -A commands
# commands[foo]=bin/intershop-foo
# commands[bar]=bin/intershop-bar
# commands[baz]=bin/intershop-baz
# echo "${!commands[@]}"
# echo "${commands[@]}"
# echo "${!commands[*]}"
# exit 1

#-----------------------------------------------------------------------------------------------------------
export intershop_host_path
export intershop_host_bin_path
export intershop_guest_path
export intershop_guest_bin_path
export intershop_guest_configuration_path
export intershop_host_configuration_path
export intershop_role

#-----------------------------------------------------------------------------------------------------------
intershop_host_path=$(pwd)
intershop_host_bin_path="$intershop_host_path"/bin
intershop_host_configuration_path="$intershop_host_path"/intershop.ptv
intershop_guest_path="$intershop_host_path"/intershop
intershop_guest_bin_path="$intershop_guest_path"/bin
intershop_guest_configuration_path="$intershop_guest_path"/intershop.ptv
intershop_role=unknown

#-----------------------------------------------------------------------------------------------------------
if ! [[ -f $intershop_host_configuration_path ]]; then
  info 'unable to find '"$intershop_host_configuration_path"
  info 'not an intershop module: '"$intershop_host_path"
  exit 1
  fi
info 'found intershop host configuration at '"$intershop_host_configuration_path"
#...........................................................................................................
if [[ -d $intershop_guest_path ]]; then
  info 'found intershop guest path at '"$intershop_guest_path"
  if [[ -f $intershop_guest_configuration_path ]]; then
    info 'found intershop guest configuration at '"$intershop_guest_configuration_path"
    info 'intershop guest bin path at '"$intershop_guest_bin_path"
    intershop_role=guest
  else
    info 'intershop guest configuration path not found at '"$intershop_guest_configuration_path"
    fi
  fi
#...........................................................................................................
if [[ $intershop_role == 'unknown' ]]; then
  info 'no intershop guest path at '"$intershop_guest_path"
  info 'intershop host bin path at '"$intershop_host_bin_path"
  intershop_role=host
  fi;
#...........................................................................................................
info 'intershop role is '"$intershop_role"

#-----------------------------------------------------------------------------------------------------------
function find_intershop_subcommand () {
  info 'looking for intershop subcommand '"$1"
  for filepath in "$1"/intershop-*; do
    help "$filepath"
    done; }

#-----------------------------------------------------------------------------------------------------------
function _list_intershop_subcommands () {
  info 'looking for intershop subcommands in '"$1"
  for filepath in "$1"/intershop-*; do
    subcommand=$(printf '%s' "$filepath" | sed -re 's/^.*\/intershop-(.+)$/\1/')
    help intershop "$subcommand"
    done; }

#-----------------------------------------------------------------------------------------------------------
function list_intershop_subcommands () {
  if [[ $intershop_role == 'guest' ]]; then _list_intershop_subcommands "$intershop_guest_bin_path"; fi
  _list_intershop_subcommands "$intershop_host_bin_path"; }

#-----------------------------------------------------------------------------------------------------------
set +u; subcommand="$1"; set -u
if [ -z "$subcommand" ]; then
  urge 'no subcommand given; available commands:'
  list_intershop_subcommands
  exit 1
  fi

exit 1

source bin/_prepare-environment

#-----------------------------------------------------------------------------------------------------------

#-----------------------------------------------------------------------------------------------------------
echo command is "$subcommand"

sub_command_executable=./bin/intershop-"$subcommand"
if [ -x "$sub_command_executable" ]; then
  echo "$0: found executable $sub_command_executable for subcommand $subcommand"
else
  echo "$0: no executable $sub_command_executable found for subcommand $subcommand"
  exit 1
  fi




# thx to https://unix.stackexchange.com/a/60808
# compgen -c | sort | grep --color=always -P '^i.*$' | less -SRN
# compgen -c | sort | grep --color=always -P '^...$' | less -SRN
# compgen -c | sort | less -SRN +G
# compgen -A function -abck | sort | less -SRN +G





